#!/bin/bash

# ============================================
# –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Å–±–æ—Ä–∫–∞ ‚Üí —Å—Ç–∞—Ç–∏–∫–∞ ‚Üí –¥–µ–ø–ª–æ–π
# ============================================

set -e

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
export STACK_NAME=${STACK_NAME:-app}
export NGINX_PORT=${NGINX_PORT:-3000}
export APP_PORT_LOCAL=${APP_PORT_LOCAL:-3001}
export GH_SHA=${GH_SHA:-$(git tag --points-at HEAD)}

echo "================================================"
echo "–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–µ–ø–ª–æ—è"
echo "================================================"
echo "STACK_NAME: $STACK_NAME"
echo "NGINX_PORT: $NGINX_PORT"
echo "APP_PORT_LOCAL: $APP_PORT_LOCAL"
echo "GH_SHA: $GH_SHA"
echo "================================================"
echo ""

# 1. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
echo "‚ñ∂ –®–∞–≥ 1/3: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞"
./build.sh

# 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
echo ""
echo "‚ñ∂ –®–∞–≥ 2/3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏"
./extract-static.sh

# 3. –î–µ–ø–ª–æ–π —Å—Ç–µ–∫–∞
echo ""
echo "‚ñ∂ –®–∞–≥ 3/3: –î–µ–ø–ª–æ–π —Å—Ç–µ–∫–∞"
./deploy.sh

echo ""
echo "================================================"
echo "üéâ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "================================================"