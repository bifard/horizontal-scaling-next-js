# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤

–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –º–æ–¥—É–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ CI/CD:

```
‚îú‚îÄ‚îÄ build.sh          # 1Ô∏è‚É£ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ extract-static.sh # 2Ô∏è‚É£ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏ –≤ volume
‚îú‚îÄ‚îÄ deploy.sh         # 3Ô∏è‚É£ –î–µ–ø–ª–æ–π Docker Stack
‚îî‚îÄ‚îÄ scripts           # üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (–≤—ã–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∏)
```

## üì¶ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è       | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é                  | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ---------------- | ----------------------------- | --------------------------------- |
| `GH_SHA`         | `$(git tag --points-at HEAD)` | –í–µ—Ä—Å–∏—è/—Ç–µ–≥ –¥–ª—è –æ–±—Ä–∞–∑–∞             |
| `APP_PORT_LOCAL` | `3001`                        | –ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ |
| `NGINX_PORT`     | `3000`                        | –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç Nginx                |
| `STACK_NAME`     | `app`                         | –ò–º—è Docker Stack                  |

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —ç—Ç–∞–ø—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
./scripts

# –ò–ª–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
NGINX_PORT=8080 APP_PORT_LOCAL=3002 ./scripts
```

### CI/CD (GitHub Actions) - —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –¥–∂–æ–±—ã

#### Job 1: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```yaml
- name: Build Docker image
  run: ./build.sh
  env:
    GH_SHA: ${{ github.sha }}
    APP_PORT_LOCAL: 3001
```

#### Job 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏

```yaml
- name: Extract static files
  run: ./extract-static.sh
  env:
    GH_SHA: ${{ github.sha }}
    STACK_NAME: app
```

#### Job 3: –î–µ–ø–ª–æ–π

```yaml
- name: Deploy stack
  run: ./deploy.sh
  env:
    GH_SHA: ${{ github.sha }}
    NGINX_PORT: 3000
    APP_PORT_LOCAL: 3001
    STACK_NAME: app
```

### –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

```bash
# –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
GH_SHA=v1.0.0 APP_PORT_LOCAL=3001 ./build.sh

# –¢–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
GH_SHA=v1.0.0 ./extract-static.sh

# –¢–æ–ª—å–∫–æ –¥–µ–ø–ª–æ–π
GH_SHA=v1.0.0 NGINX_PORT=3000 APP_PORT_LOCAL=3001 ./deploy.sh
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Dockerfile

- **ARG PORT**: –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —á–µ—Ä–µ–∑ `--build-arg PORT=3001`
- **ENV PORT**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –¥–ª—è Next.js
- **EXPOSE ${PORT}**: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ—Ä—Ç

### docker-stack.yml

- **environment.PORT**: –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `APP_PORT_LOCAL`
- **ports**: –ú–∞–ø–ø–∏–Ω–≥ `9000:${APP_PORT_LOCAL}` (–≤–Ω–µ—à–Ω–∏–π:–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
- **volumes.next_static**: –û–±—â–∏–π volume –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```
build.sh
  ‚îú‚îÄ> –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑ —Å PORT=$APP_PORT_LOCAL
  ‚îî‚îÄ> –¢–µ–≥–∏—Ä—É–µ—Ç –∫–∞–∫ horizont-app:$GH_SHA

extract-static.sh
  ‚îú‚îÄ> –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑ –æ–±—Ä–∞–∑–∞
  ‚îú‚îÄ> –ò–∑–≤–ª–µ–∫–∞–µ—Ç BUILD_ID –∏ —Å—Ç–∞—Ç–∏–∫—É
  ‚îî‚îÄ> –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ volume next_static

deploy.sh
  ‚îú‚îÄ> –ü–µ—Ä–µ–¥–∞–µ—Ç PORT=$APP_PORT_LOCAL –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  ‚îú‚îÄ> –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç volume next_static
  ‚îî‚îÄ> –ó–∞–ø—É—Å–∫–∞–µ—Ç Docker Stack
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤

–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–¥–∞–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

1. **–ü—Ä–∏ —Å–±–æ—Ä–∫–µ** (build.sh):

   ```bash
   --build-arg PORT=$APP_PORT_LOCAL
   ```

2. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ** (docker-stack.yml):
   ```yaml
   environment:
     - PORT=${APP_PORT_LOCAL}
   ```

Next.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `PORT` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
docker service ls

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker service logs app_app -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å nginx
docker service logs app_nginx -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å volume
docker run --rm -v app_next_static:/data alpine ls -la /data
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–∑
docker images | grep horizont-app

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å
docker network ls | grep alnet

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å volume
docker volume ls | grep next_static

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å stack
docker stack rm app
```

## üé≠ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ GitHub Actions

–î–ª—è —ç–º—É–ª—è—Ü–∏–∏ GitHub Actions –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **`act`**:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å act (macOS)
brew install act

# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ jobs
act -l

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π job
act -j build
act -j extract-static
act -j deploy

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ—Å—å workflow
act push

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
act workflow_dispatch --input app_port=3002 --input nginx_port=8080
```

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: —Å–º. [ACT_SETUP.md](./ACT_SETUP.md)

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `set -e` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- GH_SHA –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä–µ—Ç—Å—è –∏–∑ git tag –Ω–∞ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
- Volume `next_static` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –°—Ç–∞—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ `/dst/$BUILD_ID/_next/static`
- Workflow —Ñ–∞–π–ª: [`.github/workflows/deploy.yml`](.github/workflows/deploy.yml)
